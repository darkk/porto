#!/bin/sh

set -e

bootstrap() {
	local root=$1

	local img=/tmp/fedora.tar.xz
	[ -f $img ] || curl -o $img -L https://github.com/fedora-cloud/docker-brew-fedora/blob/21/fedora-21-release.tar.xz?raw=true

	tar -Jxf $img -C $root

	cat > $root/etc/resolv.conf <<EOF
search search.yandex.net yandex.ru
nameserver 213.180.205.1
nameserver 2a02:6b8::1:1
EOF
}

prepare() {
	sed -i -e 's@^metalink@#metalink@' -e 's@^#baseurl.*$@baseurl=http://mirror.yandex.ru/fedora/linux/releases/$releasever/Everything/$basearch/os/@' /etc/yum.repos.d/fedora.repo
	yum -y update
	yum -y install autoconf bison flex libtool fakeroot git cmake gcc gcc-c++ make libstdc++-devel libstdc++-static protobuf-static glibc-static protobuf-devel protobuf-compiler ncurses-devel @development-tools fedora-packager rpmdevtools python2-devel libnl3 libnl3-devel
}

cleanup() { :; }

check() {
	cp -aT $1 $2
	cd $2
	rm -f CMakeCache.txt
	rpmdev-setuptree

	./spec/build
	yum -y install ~/rpmbuild/RPMS/x86_64/yandex-porto-*.rpm ~/rpmbuild/RPMS/x86_64/python2-yandex-porto-*.rpm
}

eval "$@"
