#!/bin/sh

set -e
set -x

bootstrap() {
	local root=$1

	local img=/tmp/jessie.tar.xz
	[ -f $img ] || curl -o $img -L https://github.com/tianon/docker-brew-debian/raw/b962c5cf4cc855bd0ad2dae2dd21dc7a691f368c/jessie/rootfs.tar.xz

	tar -Jxf $img -C $root

	cat > $root/etc/resolv.conf <<EOF
search search.yandex.net yandex.ru
nameserver 213.180.205.1
nameserver 2a02:6b8::1:1
EOF
}

prepare() {
	apt-get update
	apt-get install -y --force-yes debhelper devscripts git cmake g++ make libprotobuf-dev protobuf-compiler bison flex pkg-config autoconf libtool libprotobuf-dev libncurses5-dev bash-completion
}

cleanup() { :; }

check() {
	mkdir -p $2
	(cd $1 && git archive --format=tar HEAD | tar -xf - -C $2)
	(cp -a $1/contrib/libnl $2/contrib)

	cd $2
	debuild -i -us -uc -b

	apt-get install -y --force-yes logrotate
	groupadd porto || :
	dpkg -i /yandex-porto_*_amd64.deb
}

eval "$@"
